name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Compact Compiler
        run: |
          curl --proto '=https' --tlsv1.2 -LsSf https://github.com/midnightntwrk/compact/releases/latest/download/compact-installer.sh | sh
        shell: bash

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.20.0 # Matching package.json packageManager
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 23 # Recommend LTS or match project requirement
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Contract (Pre-requisite)
        run: yarn contract compact

      # - name: Check Format
      #   run: pnpm exec biome format pkgs/cli pkgs/contract pkgs/frontend --diagnostic-level=error

      # - name: Lint
      #   run: pnpm -r run lint

      # Typecheck often requires build artifacts or running tsc directly.
      # 'cli' has typecheck script. 'contract' has build (which tscs). 'frontend' has build (next build).
      # We'll try running explicit typecheck where available, or build as a fallback check.
      # For now, leveraging the 'build' step at the end for full verification,
      # but ideally we want fail-fast typechecking.
      # - name: Typecheck (CLI)
      #   run: pnpm --filter cli run typecheck

      - name: Run Tests (Unit & Integration)
        # This runs 'test' script in all packages that have it.
        # contract: vitest run
        # frontend: vitest run
        # cli: NO 'test' script. Has 'test-api'.
        # We explicitly run test-api for CLI if needed, or rely on implementation plan logic.
        run: |
            pnpm -r run test
            # Optional: pnpm --filter cli run test-api


      - name: Build All
        run: pnpm -r run build
