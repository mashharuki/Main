# Patient Registry CLI - 要件定義書

## はじめに

このspecは、デプロイ済みのPatient Registryコントラクトと対話するための包括的なCLIツールセットを実装するものです。
既存のデプロイスクリプトに加えて、患者登録、統計情報取得、年齢範囲検証などの実用的な機能を提供します。

## 用語集

- **CLI (Command Line Interface)**: コマンドラインから実行可能なツール
- **Patient Registration**: 患者データをコントラクトに登録する操作
- **Registration Stats**: 登録統計情報（総数、性別ごとの数など）
- **Age Range Verification**: 特定年齢範囲の患者が存在するかの検証
- **Contract Address**: デプロイ済みコントラクトのアドレス
- **Environment Variable**: 実行時設定を提供する環境変数
- **Wallet Seed**: ウォレットを復元するための秘密鍵

## 要件

### 要件1: 患者登録CLIスクリプト

**ユーザーストーリー:**

医療機関の管理者として、コマンドラインから患者データを登録したい。
そうすることで、バッチ処理やスクリプト化された登録が可能になる。

#### 受入基準

1. WHEN register-patient.tsが実行されたとき、THE スクリプトは、環境変数から患者情報を読み込まなければならない

2. WHEN 患者年齢が提供されたとき、THE スクリプトは、PATIENT_AGE環境変数から年齢を取得しなければならない

3. WHEN 患者性別が提供されたとき、THE スクリプトは、PATIENT_GENDER環境変数から性別（0=Male, 1=Female, 2=Other）を取得しなければならない

4. WHEN 患者症状が提供されたとき、THE スクリプトは、PATIENT_CONDITION環境変数から症状を取得し、ハッシュ化しなければならない

5. WHEN 登録が完了したとき、THE スクリプトは、登録成功メッセージとトランザクションハッシュを表示しなければならない

### 要件2: 統計情報取得CLIスクリプト

**ユーザーストーリー:**

研究者として、登録された患者の統計情報を取得したい。
そうすることで、データの概要を把握し、分析の基礎データとして活用できる。

#### 受入基準

1. WHEN get-stats.tsが実行されたとき、THE スクリプトは、CONTRACT_ADDRESS環境変数からコントラクトアドレスを取得しなければならない

2. WHEN コントラクトに接続したとき、THE スクリプトは、getRegistrationStats circuitを呼び出さなければならない

3. WHEN 統計情報が取得されたとき、THE スクリプトは、総登録数を表示しなければならない

4. WHEN 統計情報が取得されたとき、THE スクリプトは、性別ごとの登録数（Male、Female、Other）を表示しなければならない

5. WHEN 統計情報が取得されたとき、THE スクリプトは、見やすいフォーマットで情報を整形して表示しなければならない

### 要件3: 年齢範囲検証CLIスクリプト

**ユーザーストーリー:**

研究者として、特定の年齢範囲に該当する患者が存在するか確認したい。
そうすることで、研究対象となる患者群の存在を事前に確認できる。

#### 受入基準

1. WHEN verify-age-range.tsが実行されたとき、THE スクリプトは、MIN_AGEとMAX_AGE環境変数から年齢範囲を取得しなければならない

2. WHEN 年齢範囲が指定されたとき、THE スクリプトは、verifyAgeRange circuitを呼び出さなければならない

3. WHEN 検証が完了したとき、THE スクリプトは、該当患者の存在有無を表示しなければならない

4. IF 該当患者が存在する場合、THEN THE スクリプトは、成功メッセージを表示しなければならない

5. IF 該当患者が存在しない場合、THEN THE スクリプトは、該当なしメッセージを表示しなければならない

### 要件4: api.tsの拡張

**ユーザーストーリー:**

開発者として、Patient Registryコントラクトとの対話を簡単に行いたい。
そうすることで、新しいCLIスクリプトを効率的に実装できる。

#### 受入基準

1. THE api.tsは、patientRegistryContractInstanceをエクスポートしなければならない

2. THE api.tsは、joinPatientRegistryContract関数を提供しなければならない

3. THE api.tsは、deployPatientRegistry関数を提供しなければならない

4. THE api.tsは、registerPatient関数を提供しなければならない

5. THE api.tsは、getRegistrationStats関数を提供しなければならない

6. THE api.tsは、verifyAgeRange関数を提供しなければならない

### 要件5: 型定義の拡張

**ユーザーストーリー:**

開発者として、TypeScriptの型安全性を活用したい。
そうすることで、コンパイル時にエラーを検出し、バグを減らせる。

#### 受入基準

1. THE common-types.tsは、PatientRegistryProviders型を定義しなければならない

2. THE common-types.tsは、PatientRegistryContract型を定義しなければならない

3. THE common-types.tsは、DeployedPatientRegistryContract型を定義しなければならない

4. THE 型定義は、既存のCounter関連の型定義と一貫性を保たなければならない

5. THE 型定義は、コントラクトの実際のインターフェースと一致しなければならない

### 要件6: package.jsonスクリプトの追加

**ユーザーストーリー:**

開発者として、npmスクリプトで簡単にCLIツールを実行したい。
そうすることで、コマンドを覚えやすく、チーム全体で統一された実行方法を使える。

#### 受入基準

1. THE package.jsonは、register:patientスクリプトを提供しなければならない

2. THE package.jsonは、stats:patient-registryスクリプトを提供しなければならない

3. THE package.jsonは、verify:age-rangeスクリプトを提供しなければならない

4. THE スクリプトは、既存のdeployスクリプトと同じ実行方法（ts-node/esm）を使用しなければならない

5. THE スクリプトは、適切なNode.jsフラグ（--experimental-specifier-resolution=node）を含まなければならない

### 要件7: エラーハンドリング

**ユーザーストーリー:**

開発者として、エラー発生時に明確なメッセージを受け取りたい。
そうすることで、問題を迅速に特定し修正できる。

#### 受入基準

1. IF 必須環境変数が設定されていない場合、THEN THE スクリプトは、どの環境変数が必要かを明示しなければならない

2. IF コントラクトアドレスが無効な場合、THEN THE スクリプトは、アドレス形式エラーを表示しなければならない

3. IF ネットワーク接続に失敗した場合、THEN THE スクリプトは、接続エラーと再試行方法を表示しなければならない

4. IF トランザクションが失敗した場合、THEN THE スクリプトは、失敗理由を詳細に表示しなければならない

5. THE すべてのスクリプトは、リソース（ウォレット、プロバイダー）を適切にクリーンアップしなければならない

### 要件8: ドキュメント作成

**ユーザーストーリー:**

開発者として、各CLIツールの使用方法を記載したドキュメントが欲しい。
そうすることで、チームメンバーが簡単にツールを使用できる。

#### 受入基準

1. THE ドキュメントは、各スクリプトの目的を説明しなければならない

2. THE ドキュメントは、必要な環境変数の一覧と説明を含まなければならない

3. THE ドキュメントは、実行例を含まなければならない

4. THE ドキュメントは、トラブルシューティングガイドを含まなければならない

5. THE ドキュメントは、既存のDEPLOYMENT.mdと統合または参照しなければならない

## 技術的制約

1. **既存コードの活用**: pkgs/cliの既存インフラを最大限活用
2. **一貫性**: 既存のcounterスクリプトと同じパターンを使用
3. **環境変数**: .envファイルで設定を管理
4. **ログ**: pinoを使用した構造化ログ
5. **TypeScript**: 既存のTypeScript設定を使用
6. **エラーハンドリング**: 既存のエラーハンドリングパターンを踏襲

## セキュリティ要件

1. ウォレットシードは環境変数で管理（ハードコード禁止）
2. 患者症状はハッシュ化してからコントラクトに送信
3. ログに機密情報（シード、プライベートキー）を含めない
4. 環境変数の検証を実装
5. 本番環境では必ず新しいシードを使用

## 非機能要件

1. **使いやすさ**: 明確なエラーメッセージと使用例
2. **信頼性**: トランザクション失敗時の適切なエラーハンドリング
3. **保守性**: 既存コードとの一貫性
4. **拡張性**: 将来的な機能追加を考慮した設計
5. **ドキュメント**: 完全な使用方法ドキュメント

## 参考資料

- 既存のcounterスクリプト: `pkgs/cli/scripts/deploy.ts`, `pkgs/cli/scripts/increment.ts`
- helixchain参考実装: `references/helixchain/contracts/scripts/`
- Midnight Documentation: https://docs.midnight.network/
