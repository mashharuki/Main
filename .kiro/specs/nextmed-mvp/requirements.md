# NextMed MVP 要件定義書

## はじめに

NextMedは、Midnight Blockchainのゼロ知識証明技術を活用し、患者のデータ主権を完全に保護しながら医療AIの発展を加速させる次世代EHR分析基盤です。本ドキュメントでは、ハッカソンで実装可能なMVP（Minimum Viable Product）の要件を定義します。

## 用語集

- **EHR (Electronic Health Record)**: 電子健康記録
- **ZK (Zero-Knowledge)**: ゼロ知識証明技術
- **Midnight Blockchain**: プライバシー保護機能を持つブロックチェーンプラットフォーム
- **Compact**: Midnight上にデプロイするスマートコントラクトを開発するプログラミング言語
- **患者 (Patient)**: データ主体である患者
- **研究者 (Researcher)**: データ利用者である研究者・AI開発者
- **医療機関 (Institution)**: データ提供者である医療機関
- **スマートコントラクト (Smart Contract)**: ブロックチェーン上で実行される機密保持可能なプログラム
- **Witness関数**: オフチェーンで実行されるプライベート入力関数
- **Ledger**: ブロックチェーン上の公開状態
- **Circuit**: ゼロ知識証明として実行される状態遷移関数(算術回路)

## 要件

### 要件1: 患者データ登録

**ユーザーストーリー:** 

患者として、自分の医療データをプラットフォームに登録したい。  
そうすることで、医療研究に貢献しながら、誰が自分の情報にアクセスするかをコントロールできる。

#### 受入基準

1. 患者が年齢、性別、症例データを送信したとき、スマートコントラクトは、データを暗号化された形式でMidnight Blockchain上に保存しなければならない
2. データが保存されたとき、スマートコントラクトは、患者の実際の身元を明かすことなく一意の患者識別子を生成しなければならない
3. スマートコントラクトは、生の医療データが公開台帳に決して露出しないことを保証しなければならない
4. 患者がデータを登録したとき、フロントエンドは、トランザクションハッシュとともに確認メッセージを表示しなければならない
5. スマートコントラクトは、年齢が0歳から150歳の範囲内であることを検証しなければならない

### 要件2: 同意管理

**ユーザーストーリー:** 

患者として、研究者が自分のデータにアクセスすることに対する同意を付与または取り消したい。  
そうすることで、自分の医療情報に対するコントロールを維持できる。

#### 受入基準

1. 患者が研究者に同意を付与したとき、スマートコントラクトは、タイムスタンプと研究者識別子とともに同意を記録しなければならない
2. 患者が同意を取り消したとき、スマートコントラクトは、直ちに研究者のアクセス権を無効化しなければならない
3. スマートコントラクトは、すべての同意変更の監査ログを維持しなければならない
4. フロントエンドは、研究者名と付与日を含むすべてのアクティブな同意のリストを表示しなければならない
5. 同意が付与または取り消されたとき、スマートコントラクトは、追跡可能なイベントを発行しなければならない

### 要件3: 研究者によるデータクエリ

**ユーザーストーリー:** 
研究者として、個々の患者記録にアクセスすることなく集計された医療データをクエリしたい。  
そうすることで、患者のプライバシーを尊重しながら研究を実施できる。

#### 受入基準

1. 研究者がクエリを送信したとき、バックエンドは、同意を付与した患者のデータに対してのみクエリを実行しなければならない
2. バックエンドは、集計統計（例：平均年齢、性別分布、症例の有病率）のみを返さなければならない
3. スマートコントラクトは、データアクセスを許可する前に、研究者が有効な同意を持っていることを検証しなければならない
4. バックエンドは、クエリが正しく実行されたことを示すゼロ知識証明を生成しなければならない
5. クエリが実行されたとき、スマートコントラクトは、クエリの詳細を明かすことなく、クエリメタデータ（研究者ID、タイムスタンプ、クエリタイプ）を記録しなければならない

### 要件4: AI分析実行

**ユーザーストーリー:**.  
研究者として、暗号化された医療データ上でAI分析を実行したい。  
そうすることで、患者のプライバシーを損なうことなく洞察を得ることができる。

#### 受入基準

1. 研究者がAIモデルを実行のために送信したとき、バックエンドは、同意を得た患者データに対してのみモデルを実行しなければならない
2. バックエンドは、生データを露出することなく、分析結果（例：相関係数、リスクスコア）を返さなければならない
3. スマートコントラクトは、ゼロ知識証明を通じて分析実行の完全性を検証しなければならない
4. フロントエンドは、ZK証明検証を示す検証バッジとともに分析結果を表示しなければならない
5. 分析が完了したとき、スマートコントラクトは、台帳上に分析メタデータを記録しなければならない

### 要件5: ウォレット統合

**ユーザーストーリー:**.  
ユーザー（患者または研究者）として、自分のMidnightウォレットをプラットフォームに接続したい。  
そうすることで、安全に認証し、ブロックチェーンと対話できる。

#### 受入基準

1. ユーザーがウォレット接続ボタンをクリックしたとき、フロントエンドは、ユーザーにLace Walletの接続を促さなければならない
2. フロントエンドは、接続されたウォレットアドレスをBech32m形式で表示しなければならない
3. ウォレット接続が失敗したとき、フロントエンドは、トラブルシューティング手順を含む明確なエラーメッセージを表示しなければならない
4. フロントエンドは、ページの再読み込みを超えてウォレット接続状態を維持しなければならない
5. ユーザーがウォレットを切断したとき、フロントエンドは、すべてのセッションデータをクリアし、ログイン画面に戻らなければならない

### 要件6: データプライバシー保護

**ユーザーストーリー:**   
患者として、自分の医療データがゼロ知識証明によって保護されることを望む。  
そうすることで、データが研究に使用される場合でも、プライバシーが保証される。

#### 受入基準

1. スマートコントラクトは、すべての医療データ操作を処理するためにMidnight上にデプロイしたスマートコントラクトを使用しなければならない
2. スマートコントラクトは、機密データのハッシュコミットメントのみが公開台帳に保存されることを保証しなければならない
3. データがアクセスされたとき、スマートコントラクトは、基礎となるデータを明かすことなくゼロ知識証明を検証しなければならない
4. スマートコントラクトは、すべてのプライベートデータ入力を処理するためにwitness関数を使用しなければならない
5. スマートコントラクトは、非機密メタデータに対してのみdisclose()ラッパーを実装しなければならない

### 要件7: 患者用ダッシュボード

**ユーザーストーリー:**   
患者として、登録されたデータと同意履歴を表示したい。  
そうすることで、自分の情報がどのように使用されているかを監視できる。

#### 受入基準

1. フロントエンドは、患者の登録された医療データ（年齢、性別、症例）を表示しなければならない
2. フロントエンドは、アクセスを許可されたすべての研究者のリストを表示しなければならない
3. フロントエンドは、タイムスタンプを含むすべてのデータアクセスイベントの監査ログを表示しなければならない
4. フロントエンドは、各研究者の同意を取り消すボタンを提供しなければならない
5. データが更新されたとき、フロントエンドは、ダッシュボードを自動的に更新しなければならない

### 要件8: 研究者用ダッシュボード

**ユーザーストーリー:**.  
研究者として、利用可能なデータセットを表示し、クエリを実行したい。  
そうすることで、効率的に医療研究を実施できる。

#### 受入基準

1. フロントエンドは、利用可能なデータセットに関する統計（総患者数、データタイプ、同意状況）を表示しなければならない
2. フロントエンドは、データ分析リクエストを送信するためのクエリインターフェースを提供しなければならない
3. フロントエンドは、結果と検証状況を含む過去のクエリの履歴を表示しなければならない
4. フロントエンドは、AI分析ジョブのステータス（保留中、実行中、完了）を表示しなければならない
5. クエリが完了したとき、フロントエンドは、研究者に通知し、結果を表示しなければならない

### 要件9: スマートコントラクトデプロイ

**ユーザーストーリー:**.  
開発者として、NextMedスマートコントラクトをMidnight Testnetにデプロイしたい。  
そうすることで、プラットフォームがライブブロックチェーン環境で動作できる。

#### 受入基準

1. スマートコントラクトは、Compact言語バージョン0.16以上で記述されなければならない
2. スマートコントラクトは、Compactコンパイラで正常にコンパイルされなければならない
3. スマートコントラクトは、エラーなくMidnight Testnet-02にデプロイされなければならない
4. スマートコントラクトは、患者登録、同意管理、データクエリのためのエクスポートされた回路を公開しなければならない
5. スマートコントラクトは、デフォルトの台帳状態値で初期化されなければならない

### 要件10: バックエンドAPI統合

**ユーザーストーリー:**.  
フロントエンド開発者として、スマートコントラクトと対話するためのREST APIが欲しい。  
そうすることで、ユーザーフレンドリーなインターフェースを構築できる。

#### 受入基準

1. バックエンドは、患者登録、同意管理、データクエリのためのAPIエンドポイントを提供しなければならない
2. バックエンドは、スマートコントラクトに転送する前にすべてのAPIリクエストを検証しなければならない
3. バックエンドは、適切なHTTPステータスコードを含む標準化されたJSON応答を返さなければならない
4. バックエンドは、エラーを適切に処理し、意味のあるエラーメッセージを返さなければならない
5. バックエンドは、悪用を防ぐためにレート制限を実装しなければならない

