# NextMed MVP 実装タスクリスト

## タスク概要

このタスクリストは、NextMed MVPをハッカソンで実装するための段階的な実装計画です。各タスクは、前のタスクの成果物を基に構築され、最終的に完全に機能するプラットフォームを実現します。

---

## - [ ] 1. プロジェクト初期セットアップ

### - [ ] 1.1 モノレポ構造の作成
- pnpm workspaceの設定
- `pkgs/contract`, `pkgs/backend`, `pkgs/frontend`ディレクトリの作成
- ルートレベルの`package.json`と`pnpm-workspace.yaml`の設定
- _要件: 要件9_

### - [ ] 1.2 開発環境の構築
- Node.js 18 LTSのインストール確認
- pnpm 10.20.0のインストール
- Compact Compilerのインストールと`COMPACT_HOME`環境変数の設定
- Docker Desktopのインストールと起動確認
- _要件: 要件9_

### - [ ] 1.3 Lace Walletのセットアップ
- Lace Wallet Chrome拡張機能のインストール
- Testnet用ウォレットの作成
- Midnight Testnet FaucetからのtDUST取得
- _要件: 要件5_

### - [ ] 1.4 Proof Serverの起動
- Docker経由でProof Serverを起動
- `docker run -p 6300:6300 midnightnetwork/proof-server -- 'midnight-proof-server --network testnet'`
- Proof Serverの動作確認
- _要件: 要件9_

---

## - [ ] 2. スマートコントラクトの実装（TDD）

### - [ ] 2.1 Compactプロジェクトのセットアップ
- `pkgs/contract`ディレクトリの初期化
- `package.json`の作成（依存関係: `@midnight-ntwrk/compact-runtime`, `vitest`）
- `tsconfig.json`の設定
- Vitestテスト環境のセットアップ
- _要件: 要件9_

### - [ ] 2.2 患者データ登録機能（TDD）
- [ ] 2.2.1 患者データ登録のテストを書く
  - 正常系: 有効な年齢、性別、症例で患者登録が成功するテスト
  - 異常系: 無効な年齢（151歳以上、負の値）で登録が失敗するテスト
  - 異常系: 患者IDが一意に生成されることを確認するテスト
  - _要件: 要件1_
- [ ] 2.2.2 テストを通すための最小限の実装
  - `PatientData`構造体の定義
  - `patients: Map<Bytes<32>, PatientData>`のLedger宣言
  - `patientCount: Counter`のLedger宣言
  - `registerPatient`回路の実装（年齢バリデーション、患者IDハッシュ生成）
  - _要件: 要件1, 要件6_
- [ ] 2.2.3 リファクタリング
  - コードの重複を削除
  - ヘルパー関数の抽出
  - _要件: 要件1_

### - [ ] 2.3 同意管理機能（TDD）
- [ ] 2.3.1 同意管理のテストを書く
  - 正常系: 同意付与が成功するテスト
  - 正常系: 同意取り消しが成功するテスト
  - 正常系: 同意確認が正しく動作するテスト
  - 異常系: 存在しない患者IDで同意付与が失敗するテスト
  - _要件: 要件2_
- [ ] 2.3.2 テストを通すための最小限の実装
  - `ConsentRecord`構造体の定義
  - `consents: Map<Bytes<32>, Map<Bytes<32>, ConsentRecord>>`のLedger宣言
  - `grantConsent`回路の実装
  - `revokeConsent`回路の実装
  - `checkConsent`回路の実装
  - _要件: 要件2_
- [ ] 2.3.3 リファクタリング
  - 同意管理ロジックの最適化
  - タイムスタンプ処理の共通化
  - _要件: 要件2_

### - [ ] 2.4 クエリ記録機能（TDD）
- [ ] 2.4.1 クエリ記録のテストを書く
  - 正常系: クエリメタデータが正しく記録されるテスト
  - 正常系: クエリ履歴が正しく取得できるテスト
  - _要件: 要件3_
- [ ] 2.4.2 テストを通すための最小限の実装
  - `QueryMetadata`構造体の定義
  - `queryHistory: List<QueryMetadata>`のLedger宣言
  - `recordQuery`回路の実装
  - _要件: 要件3_
- [ ] 2.4.3 リファクタリング
  - クエリ記録ロジックの最適化
  - _要件: 要件3_

### - [ ] 2.5 Witness関数の実装（TDD）
- [ ] 2.5.1 Witness関数のテストを書く
  - `getSecretKey`のモックテスト
  - `getConditionData`のモックテスト
  - _要件: 要件6_
- [ ] 2.5.2 テストを通すための最小限の実装
  - Compact側のwitness宣言
  - TypeScript側のwitness実装
  - _要件: 要件6_
- [ ] 2.5.3 リファクタリング
  - Witness関数の最適化
  - _要件: 要件6_

### - [ ] 2.6 統合テストとデプロイ
- 全回路の統合テスト
- Compactコンパイラでのコンパイル
- ZK証明鍵の生成
- Midnight Testnet-02へのデプロイ
- デプロイ後のコントラクトアドレス確認
- _要件: 要件9_

---

## - [ ] 3. バックエンドAPIの実装（TDD）

### - [ ] 3.1 Expressサーバーのセットアップ
- `pkgs/backend`ディレクトリの初期化
- Express、TypeScript、必要な依存関係のインストール（`vitest`, `supertest`）
- サーバーの基本構成（ポート、CORS、ミドルウェア）
- Vitestテスト環境のセットアップ
- _要件: 要件10_

### - [ ] 3.2 Midnight SDKの統合
- `@midnight-ntwrk/midnight-js-contracts`の統合
- コントラクトインスタンスの初期化
- ウォレットプロバイダーの設定
- _要件: 要件10_

### - [ ] 3.3 患者関連APIエンドポイント（TDD）
- [ ] 3.3.1 患者登録APIのテストを書く
  - 正常系: 有効なデータで201が返るテスト
  - 異常系: 無効な年齢で400が返るテスト
  - 異常系: 必須フィールド欠如で400が返るテスト
  - _要件: 要件1, 要件10_
- [ ] 3.3.2 テストを通すための最小限の実装
  - `POST /api/patients/register`の実装
  - リクエストバリデーション
  - スマートコントラクト呼び出し
  - _要件: 要件1, 要件10_
- [ ] 3.3.3 患者データ取得APIのテストを書く
  - 正常系: 存在する患者IDで200が返るテスト
  - 異常系: 存在しない患者IDで404が返るテスト
  - _要件: 要件1, 要件10_
- [ ] 3.3.4 テストを通すための最小限の実装
  - `GET /api/patients/:id`の実装
  - `GET /api/patients/:id/consents`の実装
  - _要件: 要件1, 要件10_
- [ ] 3.3.5 リファクタリング
  - 共通バリデーションロジックの抽出
  - エラーハンドリングの統一
  - _要件: 要件1, 要件10_

### - [ ] 3.4 同意管理APIエンドポイント（TDD）
- [ ] 3.4.1 同意管理APIのテストを書く
  - 正常系: 同意付与で200が返るテスト
  - 正常系: 同意取り消しで200が返るテスト
  - 異常系: 存在しない患者IDで404が返るテスト
  - _要件: 要件2, 要件10_
- [ ] 3.4.2 テストを通すための最小限の実装
  - `POST /api/consents/grant`の実装
  - `POST /api/consents/revoke`の実装
  - `GET /api/consents/check`の実装
  - _要件: 要件2, 要件10_
- [ ] 3.4.3 リファクタリング
  - 同意管理ロジックの最適化
  - _要件: 要件2, 要件10_

### - [ ] 3.5 研究者関連APIエンドポイント（TDD）
- [ ] 3.5.1 データクエリAPIのテストを書く
  - 正常系: 同意済みデータの集計結果が返るテスト
  - 異常系: 同意なしで403が返るテスト
  - 正常系: ZK証明が含まれることを確認するテスト
  - _要件: 要件3, 要件10_
- [ ] 3.5.2 テストを通すための最小限の実装
  - `GET /api/researchers/datasets`の実装
  - `POST /api/researchers/query`の実装
  - `GET /api/researchers/queries/:id`の実装
  - データ集計ロジックの実装
  - _要件: 要件3, 要件10_
- [ ] 3.5.3 リファクタリング
  - データ集計ロジックの最適化
  - キャッシュ戦略の実装
  - _要件: 要件3, 要件10_

### - [ ] 3.6 AI分析エンドポイント（TDD）
- [ ] 3.6.1 AI分析APIのテストを書く
  - 正常系: 分析結果が返るテスト
  - 異常系: 同意なしで403が返るテスト
  - 正常系: ZK証明が含まれることを確認するテスト
  - _要件: 要件4_
- [ ] 3.6.2 テストを通すための最小限の実装
  - `POST /api/researchers/analyze`の実装
  - AI分析エンジンの統合（簡易版）
  - 分析結果の生成
  - _要件: 要件4_
- [ ] 3.6.3 リファクタリング
  - AI分析ロジックの最適化
  - _要件: 要件4_

### - [ ] 3.7 エラーハンドリングミドルウェア（TDD）
- [ ] 3.7.1 エラーハンドリングのテストを書く
  - バリデーションエラーで400が返るテスト
  - 同意エラーで403が返るテスト
  - 内部エラーで500が返るテスト
  - _要件: 要件10_
- [ ] 3.7.2 テストを通すための最小限の実装
  - グローバルエラーハンドラー
  - バリデーションエラーハンドリング
  - 同意エラーハンドリング
  - 標準化されたエラーレスポンス
  - _要件: 要件10_
- [ ] 3.7.3 リファクタリング
  - エラーハンドリングロジックの統一
  - _要件: 要件10_

---

## - [ ] 4. フロントエンドの実装（TDD）

### - [ ] 4.1 Next.jsプロジェクトのセットアップ
- `pkgs/frontend`ディレクトリの初期化
- Next.js 16.0.0、React 19.2.0のインストール
- Tailwind CSS、shadcn/uiの設定
- TypeScript設定
- Vitest + React Testing Libraryのセットアップ
- _要件: 要件5, 要件7, 要件8_

### - [ ] 4.2 共通UIコンポーネント（TDD）
- [ ] 4.2.1 共通コンポーネントのテストを書く
  - ローディングスピナーの表示テスト
  - トーストメッセージの表示テスト
  - エラーメッセージの表示テスト
  - 確認ダイアログの動作テスト
  - _要件: 要件5, 要件7, 要件8_
- [ ] 4.2.2 テストを通すための最小限の実装
  - ローディングスピナーコンポーネント
  - トーストメッセージコンポーネント
  - エラーメッセージコンポーネント
  - 確認ダイアログコンポーネント
  - _要件: 要件5, 要件7, 要件8_
- [ ] 4.2.3 リファクタリング
  - コンポーネントの最適化
  - スタイリングの統一
  - _要件: 要件5, 要件7, 要件8_

### - [ ] 4.3 ウォレット統合（TDD）
- [ ] 4.3.1 ウォレット接続のテストを書く
  - ウォレット接続ボタンのクリックテスト
  - ウォレットアドレス表示テスト
  - ウォレット切断テスト
  - エラーハンドリングテスト
  - _要件: 要件5_
- [ ] 4.3.2 テストを通すための最小限の実装
  - Lace Wallet DApp Connectorの統合
  - ウォレット接続コンポーネントの作成
  - ウォレット状態管理（Context API）
  - 接続/切断機能の実装
  - _要件: 要件5_
- [ ] 4.3.3 リファクタリング
  - ウォレット状態管理の最適化
  - エラーハンドリングの改善
  - _要件: 要件5_

### - [ ] 4.4 ランディングページとログイン画面（TDD）
- [ ] 4.4.1 ランディングページのテストを書く
  - ヒーローセクションの表示テスト
  - 機能紹介セクションの表示テスト
  - ログインボタンのクリックテスト
  - レスポンシブデザインのテスト
  - _要件: 要件5_
- [ ] 4.4.2 テストを通すための最小限の実装
  - ランディングページの作成
  - ログイン画面の作成（ウォレット接続UI、ロール選択）
  - _要件: 要件5_
- [ ] 4.4.3 リファクタリング
  - レイアウトの最適化
  - _要件: 要件5_

### - [ ] 4.5 患者データ登録フォーム（TDD）
- [ ] 4.5.1 患者データ登録フォームのテストを書く
  - フォーム入力のバリデーションテスト
  - 送信ボタンのクリックテスト
  - トランザクション署名のテスト
  - 成功メッセージの表示テスト
  - エラーハンドリングのテスト
  - _要件: 要件1_
- [ ] 4.5.2 テストを通すための最小限の実装
  - 年齢入力フィールド
  - 性別選択ドロップダウン
  - 症例入力フィールド
  - フォームバリデーション
  - 送信処理とトランザクション署名
  - _要件: 要件1_
- [ ] 4.5.3 リファクタリング
  - フォームロジックの最適化
  - バリデーションの改善
  - _要件: 要件1_

### - [ ] 4.6 患者ダッシュボード（TDD）
- [ ] 4.6.1 患者ダッシュボードのテストを書く
  - 登録データ表示のテスト
  - 同意リスト表示のテスト
  - 監査ログ表示のテスト
  - ナビゲーションメニューのテスト
  - _要件: 要件7_
- [ ] 4.6.2 テストを通すための最小限の実装
  - 登録データ表示コンポーネント
  - 同意リスト表示コンポーネント
  - 監査ログ表示コンポーネント
  - ナビゲーションメニュー
  - _要件: 要件7_
- [ ] 4.6.3 リファクタリング
  - ダッシュボードレイアウトの最適化
  - _要件: 要件7_

### - [ ] 4.7 同意管理UI（TDD）
- [ ] 4.7.1 同意管理UIのテストを書く
  - 研究者リスト表示のテスト
  - 同意付与ボタンのクリックテスト
  - 同意取り消しボタンのクリックテスト
  - 確認ダイアログのテスト
  - _要件: 要件2_
- [ ] 4.7.2 テストを通すための最小限の実装
  - 研究者リスト表示
  - 同意付与ボタン
  - 同意取り消しボタン
  - 確認ダイアログ
  - _要件: 要件2_
- [ ] 4.7.3 リファクタリング
  - 同意管理UIの最適化
  - _要件: 要件2_

### - [ ] 4.8 研究者ダッシュボード（TDD）
- [ ] 4.8.1 研究者ダッシュボードのテストを書く
  - データセット統計表示のテスト
  - クエリ履歴表示のテスト
  - AI分析ジョブステータス表示のテスト
  - ナビゲーションメニューのテスト
  - _要件: 要件8_
- [ ] 4.8.2 テストを通すための最小限の実装
  - データセット統計表示
  - クエリ履歴表示
  - AI分析ジョブステータス表示
  - ナビゲーションメニュー
  - _要件: 要件8_
- [ ] 4.8.3 リファクタリング
  - ダッシュボードレイアウトの最適化
  - _要件: 要件8_

### - [ ] 4.9 データクエリUI（TDD）
- [ ] 4.9.1 データクエリUIのテストを書く
  - クエリタイプ選択のテスト
  - クエリ実行ボタンのクリックテスト
  - 結果表示のテスト
  - ZK証明検証バッジの表示テスト
  - _要件: 要件3_
- [ ] 4.9.2 テストを通すための最小限の実装
  - クエリタイプ選択
  - クエリ実行ボタン
  - 結果表示コンポーネント
  - ZK証明検証バッジ
  - _要件: 要件3_
- [ ] 4.9.3 リファクタリング
  - クエリUIの最適化
  - _要件: 要件3_

### - [ ] 4.10 AI分析UI（TDD）
- [ ] 4.10.1 AI分析UIのテストを書く
  - 分析設定フォームのテスト
  - 分析実行ボタンのクリックテスト
  - 結果表示のテスト
  - ZK証明検証バッジの表示テスト
  - _要件: 要件4_
- [ ] 4.10.2 テストを通すための最小限の実装
  - 分析設定フォーム
  - 分析実行ボタン
  - 結果表示（相関係数、リスクスコア）
  - ZK証明検証バッジ
  - _要件: 要件4_
- [ ] 4.10.3 リファクタリング
  - AI分析UIの最適化
  - _要件: 要件4_

---

## - [ ] 5. E2Eテストと統合テスト

### - [ ] 5.1 E2Eテスト環境のセットアップ
- Playwrightのインストールと設定
- テスト用のモックウォレットの準備
- テストデータの準備
- _要件: すべて_

### - [ ] 5.2 患者登録フローのE2Eテスト（TDD）
- [ ] 5.2.1 患者登録フローのE2Eテストを書く
  - ランディングページからログインまでのフロー
  - ウォレット接続のフロー
  - データ登録フォーム入力のフロー
  - トランザクション署名のフロー
  - 成功メッセージ表示の確認
  - _要件: 要件1, 要件5_
- [ ] 5.2.2 テストが通ることを確認
  - E2Eテストの実行
  - 失敗箇所の修正
  - _要件: 要件1, 要件5_

### - [ ] 5.3 同意管理フローのE2Eテスト（TDD）
- [ ] 5.3.1 同意管理フローのE2Eテストを書く
  - 患者ダッシュボードへのアクセス
  - 研究者リストの表示
  - 同意付与のフロー
  - 同意取り消しのフロー
  - _要件: 要件2, 要件7_
- [ ] 5.3.2 テストが通ることを確認
  - E2Eテストの実行
  - 失敗箇所の修正
  - _要件: 要件2, 要件7_

### - [ ] 5.4 データクエリフローのE2Eテスト（TDD）
- [ ] 5.4.1 データクエリフローのE2Eテストを書く
  - 研究者ダッシュボードへのアクセス
  - クエリ実行のフロー
  - 結果表示の確認
  - ZK証明検証バッジの確認
  - _要件: 要件3, 要件8_
- [ ] 5.4.2 テストが通ることを確認
  - E2Eテストの実行
  - 失敗箇所の修正
  - _要件: 要件3, 要件8_

### - [ ] 5.5 AI分析フローのE2Eテスト（TDD）
- [ ] 5.5.1 AI分析フローのE2Eテストを書く
  - AI分析実行のフロー
  - 結果表示の確認
  - ZK証明検証バッジの確認
  - _要件: 要件4, 要件8_
- [ ] 5.5.2 テストが通ることを確認
  - E2Eテストの実行
  - 失敗箇所の修正
  - _要件: 要件4, 要件8_

### - [ ] 5.6 パフォーマンステスト
- データ集計のパフォーマンス測定
- ZK証明生成時間の測定
- フロントエンドのレンダリング速度測定
- パフォーマンスボトルネックの特定と改善
- _要件: 要件3, 要件4_

---

## - [ ] 6. デプロイメントと最終調整

### - [ ] 6.1 環境変数の設定
- `.env.example`ファイルの作成
- 必要な環境変数のドキュメント化
- 本番環境用の環境変数設定
- _要件: 要件9_

### - [ ] 6.2 ビルドスクリプトの作成
- コントラクトのビルドスクリプト
- バックエンドのビルドスクリプト
- フロントエンドのビルドスクリプト
- 統合ビルドスクリプト
- _要件: 要件9_

### - [ ] 6.3 デプロイメントスクリプトの作成
- コントラクトデプロイスクリプト
- バックエンドデプロイ設定
- フロントエンドデプロイ設定（Vercel）
- _要件: 要件9_

### - [ ] 6.4 ドキュメントの作成
- README.mdの作成（プロジェクト概要、セットアップ手順）
- API仕様書の作成
- ユーザーガイドの作成
- 開発者ガイドの作成
- _要件: すべて_

### - [ ] 6.5 セキュリティレビュー
- 環境変数の漏洩チェック
- APIエンドポイントのセキュリティ確認
- スマートコントラクトのセキュリティ監査
- _要件: 要件6_

### - [ ] 6.6 最終動作確認
- 全機能の動作確認
- エラーハンドリングの確認
- レスポンシブデザインの確認
- ブラウザ互換性の確認
- _要件: すべて_

---

## - [ ] 7. デモ準備

### - [ ] 7.1 デモシナリオの作成
- 患者データ登録デモ
- 同意管理デモ
- データクエリデモ
- AI分析デモ
- _要件: すべて_

### - [ ] 7.2 テストデータの準備
- サンプル患者データの作成
- サンプル研究者アカウントの作成
- デモ用の同意関係の設定
- _要件: 要件1, 要件2_

### - [ ] 7.3 プレゼンテーション資料の作成
- プロジェクト概要スライド
- 技術アーキテクチャスライド
- デモ動画の作成
- _要件: すべて_

---

## タスク実行の優先順位

### フェーズ1: 基盤構築（1日目）
- タスク1: プロジェクト初期セットアップ
- タスク2: スマートコントラクトの実装（TDD）
  - **Red → Green → Refactor**のサイクルを厳守

### フェーズ2: バックエンド開発（2日目）
- タスク3: バックエンドAPIの実装（TDD）
  - **Red → Green → Refactor**のサイクルを厳守

### フェーズ3: フロントエンド開発（3日目）
- タスク4: フロントエンドの実装（TDD）
  - **Red → Green → Refactor**のサイクルを厳守

### フェーズ4: 統合とE2Eテスト（4日目）
- タスク5: E2Eテストと統合テスト
  - **Red → Green → Refactor**のサイクルを厳守

### フェーズ5: デプロイとデモ準備（5日目）
- タスク6: デプロイメントと最終調整
- タスク7: デモ準備

## TDD実践のための注意事項

### 基本原則
1. **Red（失敗するテストを書く）**: まず、期待する動作を定義するテストを書きます。このテストは最初は失敗します。
2. **Green（テストを通す）**: テストを通すための最小限のコードを書きます。完璧である必要はありません。
3. **Refactor（リファクタリング）**: テストが通った後、コードを改善します。テストが引き続き通ることを確認しながら進めます。

### 実践のポイント
- **小さなステップで進める**: 一度に大きな機能を実装しようとせず、小さな単位でテストと実装を繰り返します
- **テストファースト**: コードを書く前に必ずテストを書きます
- **テストが通ったらコミット**: Red → Green → Refactorの各サイクルが完了したらコミットします
- **テストカバレッジを意識**: すべての重要な機能とエッジケースをテストでカバーします
- **リファクタリングを恐れない**: テストがあるので、安心してコードを改善できます

### ハッカソン特有の考慮事項
- 時間制約がある場合でも、最低限のテストは必ず書きます
- テストがあることで、後からの変更やデバッグが容易になります
- エラーが発生した場合は、早期に対処してください
- コミットは頻繁に行い、進捗を記録してください

