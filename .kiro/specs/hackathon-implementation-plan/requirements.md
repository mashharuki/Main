# NextMed ハッカソン実装計画 - 要件定義書

## はじめに

NextMedは、Midnight Blockchainのゼロ知識証明技術を活用し、患者のデータ主権を完全に保護しながら医療AIの発展を加速させる次世代EHR分析基盤です。

本ドキュメントでは、2025年1月下旬のハッカソンに向けた実装可能な要件を定義します。既存のNextMed MVPを基盤として、**インセンティブ機能とトークンエコノミー**を追加実装します。

## 用語集

- **NextMed**: 医療データプライバシー保護プラットフォーム
- **ZKDataMasking**: ゼロ知識証明によるデータマスキング機能
- **IncentivePool**: 研究者からの支払いを患者に分配するスマートコントラクト
- **NEXTトークン**: プラットフォーム内で使用されるインセンティブトークン
- **My Data Wallet**: 患者が自身のデータと報酬を管理するダッシュボード
- **Data Fee Pool**: 研究者が支払うデータアクセス料金のプール
- **患者 (Patient)**: データ主体である患者
- **研究者 (Researcher)**: データ利用者である研究者・AI開発者
- **Lace Wallet**: Midnight対応のウォレット

## 要件

### 要件1: ZKデータマスキング機能

**ユーザーストーリー:** 
患者として、自分の医療データが完全に匿名化された状態で研究に使用されることを望む。
そうすることで、プライバシーを保護しながら医療研究に貢献できる。

#### 受入基準

1. 患者が医療データを登録したとき、ZKDataMaskingコントラクトは、データを暗号化してMidnight Blockchain上に保存しなければならない
2. データがアクセスされたとき、ZKDataMaskingコントラクトは、元のデータを露出することなくゼロ知識証明を生成しなければならない
3. ZKDataMaskingコントラクトは、データの統計的特性（平均、分散など）のみを研究者に提供しなければならない
4. ZKDataMaskingコントラクトは、個別の患者データを決して公開台帳に露出してはならない
5. データマスキングが実行されたとき、ZKDataMaskingコントラクトは、マスキング操作の証明を生成しなければならない

### 要件2: インセンティブプール機能

**ユーザーストーリー:** 
研究者として、データアクセスに対して適切な対価を支払いたい。
患者として、自分のデータが使用された際に公正な報酬を受け取りたい。

#### 受入基準

1. 研究者がデータアクセス料を支払ったとき、IncentivePoolコントラクトは、料金をプールに追加しなければならない
2. データが使用されたとき、IncentivePoolコントラクトは、プール内の資金を関連する患者に自動分配しなければならない
3. IncentivePoolコントラクトは、すべての支払いと分配の記録を透明に管理しなければならない
4. 患者がウォレットを確認したとき、IncentivePoolコントラクトは、正確な残高を表示しなければならない
5. IncentivePoolコントラクトは、不正な支払いや分配を防ぐためのセキュリティ機能を実装しなければならない

### 要件3: My Data Wallet機能

**ユーザーストーリー:** 
患者として、自分のデータ使用状況と獲得した報酬を一目で確認したい。
そうすることで、データ提供の価値を実感し、継続的な参加を促進できる。

#### 受入基準

1. 患者がMy Data Walletにアクセスしたとき、フロントエンドは、現在のNEXTトークン残高を表示しなければならない
2. My Data Walletは、データが使用された回数と獲得した報酬の履歴を表示しなければならない
3. My Data Walletは、「アクセスを許可（Grant Access）」ボタンを提供し、研究者への同意管理を可能にしなければならない
4. 同意が付与されたとき、My Data Walletは、midnight.sendMnTransactionを介してオンチェーンに同意状態を記録しなければならない
5. My Data Walletは、ページの再読み込み後も状態を維持しなければならない

### 要件4: 研究者データ購入機能

**ユーザーストーリー:** 
研究者として、必要なデータセットを検索し、適切な料金を支払ってアクセス権を購入したい。
そうすることで、効率的に医療研究を実施できる。

#### 受入基準

1. 研究者がデータセット検索を実行したとき、フロントエンドは、利用可能なデータの統計情報を表示しなければならない
2. 研究者がデータアクセスを購入したとき、フロントエンドは、支払い金額と対象データを明確に表示しなければならない
3. 支払いが完了したとき、研究者用UIは、アクセス権の確認とデータ利用開始の案内を表示しなければならない
4. 研究者がデータを利用したとき、フロントエンドは、匿名化されたデータと分析結果のみを表示しなければならない
5. 研究者用UIは、過去の購入履歴と利用状況を表示しなければならない

### 要件5: E2Eインセンティブフロー

**ユーザーストーリー:** 
システム全体として、研究者の支払いから患者の報酬受取りまでの完全な経済圏を実現したい。
そうすることで、持続可能な医療データエコシステムを構築できる。

#### 受入基準

1. 研究者が「データアクセス料」を支払ったとき、システムは、料金を「データ料金プール（Data Fee Pool）」に追加しなければならない
2. データが使用されたとき、システムは、プール内の資金を関連する患者のウォレットに自動分配しなければならない
3. 患者のウォレット残高が更新されたとき、My Data Walletは、リアルタイムで新しい残高を表示しなければならない
4. システムは、すべてのトークンフローを監査可能な形で記録しなければならない
5. E2Eフローが完了したとき、システムは、計算の正確性を証明するテストログを生成しなければならない

### 要件6: Laceウォレット統合

**ユーザーストーリー:** 
ユーザー（患者または研究者）として、Lace Walletを使用してプラットフォームに安全に接続したい。
そうすることで、トークンの管理と取引を安全に実行できる。

#### 受入基準

1. ユーザーがウォレット接続ボタンをクリックしたとき、フロントエンドは、Lace Walletの接続を促さなければならない
2. ウォレット接続が成功したとき、フロントエンドは、ウォレットアドレスとNEXTトークン残高を表示しなければならない
3. トランザクションが実行されたとき、フロントエンドは、Lace Walletを通じて署名を要求しなければならない
4. ウォレット接続が失敗したとき、フロントエンドは、明確なエラーメッセージとトラブルシューティング手順を表示しなければならない
5. ユーザーがウォレットを切断したとき、フロントエンドは、すべてのセッションデータをクリアしなければならない

### 要件7: デモ対応機能

**ユーザーストーリー:** 
ハッカソンの審査員として、システムの動作を短時間で理解し、評価したい。
開発者として、システムの価値を効果的にデモンストレーションしたい。

#### 受入基準

1. デモ用のサンプルデータが準備されたとき、システムは、リアルなシナリオを再現しなければならない
2. デモ実行時に、フロントエンドは、各ステップの進行状況を視覚的に表示しなければならない
3. トークンフローのデモが実行されたとき、システムは、支払いから分配までの全プロセスを3分以内で完了しなければならない
4. デモ完了時に、システムは、実行結果の要約とメトリクスを表示しなければならない
5. デモ環境は、リセット機能を提供し、繰り返し実行を可能にしなければならない

## 技術制約

### Midnight Blockchain制約
- Compact言語バージョン: 0.16.0 - 0.25.0
- Testnet-02環境での動作
- Lace Walletとの互換性

### 開発期間制約
- 実装期間: 4週間（2025年1月）
- デモ準備: 最終週
- テスト期間: 各週末

### パフォーマンス制約
- ウォレット接続: 5秒以内
- トランザクション実行: 30秒以内
- データ検索: 3秒以内
- 残高更新: リアルタイム

## 成功指標

### マイルストーン #1: ZKコントラクト & フロントエンド連携テスト
- ZKDataMaskingとIncentivePoolのデプロイ完了
- Testnetでのトランザクション実行確認
- GitHubリポジトリの整備

### マイルストーン #2: 患者用「My Data Wallet」プロトタイプ
- 残高表示機能の実装
- Laceウォレット連携の完成
- 同意管理機能の実装

### マイルストーン #3: 研究者クエリ & E2Eインセンティブテスト
- 研究者用データ購入UI
- 完全なトークンフロー検証
- デモ動画の作成

## 実装優先順位

1. **最高優先度**: ZKDataMasking, IncentivePool スマートコントラクト
2. **高優先度**: My Data Wallet UI, Laceウォレット統合
3. **中優先度**: 研究者データ購入UI
4. **低優先度**: 高度な分析機能、詳細な監査ログ

この要件定義により、ハッカソンでの実装可能性と審査員へのインパクトを両立した開発計画を実現します。