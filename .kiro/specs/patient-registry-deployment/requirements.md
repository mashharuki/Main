# Patient Registry Deployment - 要件定義書

## はじめに

このspecは、実装済みのPatient Registryコントラクトを各種環境にデプロイし、動作確認を行うためのものです。
Midnight Testnet-02への本番デプロイを含む、完全なデプロイメントパイプラインを構築します。

## 用語集

- **Deployment (デプロイ)**: コントラクトをブロックチェーンに配置すること
- **Standalone Environment**: ローカルDocker環境
- **Testnet**: Midnight Testnet-02（公開テストネットワーク）
- **Wallet Seed**: ウォレットを復元するための秘密鍵
- **Contract Address**: デプロイされたコントラクトの一意のアドレス
- **Transaction Hash**: トランザクションの一意識別子
- **State Cache**: ウォレットとコントラクトの状態を保存するファイル

## 要件

### 要件1: デプロイスクリプトの作成

**ユーザーストーリー:**

開発者として、Patient Registryコントラクトを各種環境にデプロイしたい。
そうすることで、コントラクトの動作を実環境で確認できる。

#### 受入基準

1. WHEN デプロイスクリプトが実行されたとき、THE スクリプトは、環境変数から設定を読み込まなければならない

2. WHEN ウォレットシードが提供されたとき、THE スクリプトは、シードからウォレットを復元しなければならない

3. WHEN ウォレットが作成されたとき、THE スクリプトは、十分な資金があることを確認しなければならない

4. WHEN コントラクトがデプロイされたとき、THE スクリプトは、コントラクトアドレスとトランザクションハッシュを出力しなければならない

5. WHEN デプロイが完了したとき、THE スクリプトは、状態をキャッシュファイルに保存しなければならない

### 要件2: 環境設定の管理

**ユーザーストーリー:**

開発者として、異なる環境（standalone、testnet）に簡単に切り替えたい。
そうすることで、開発からテスト、本番まで一貫したワークフローを維持できる。

#### 受入基準

1. THE スクリプトは、NETWORK_ENV_VAR環境変数から対象ネットワークを決定しなければならない

2. THE スクリプトは、standalone、testnet-local、testnetの3つの環境をサポートしなければならない

3. WHEN 環境が指定されないとき、THE スクリプトは、デフォルトでtestnetを使用しなければならない

4. THE スクリプトは、各環境に応じた適切な設定（RPC URL、Indexer URL等）を使用しなければならない

5. THE スクリプトは、.envファイルから環境変数を読み込めなければならない

### 要件3: デプロイ検証

**ユーザーストーリー:**

開発者として、デプロイされたコントラクトが正しく動作することを確認したい。
そうすることで、デプロイの成功を保証できる。

#### 受入基準

1. WHEN 検証スクリプトが実行されたとき、THE スクリプトは、デプロイ情報ファイルからコントラクトアドレスを読み込まなければならない

2. WHEN コントラクトに接続したとき、THE スクリプトは、初期状態（カウンター=0）を確認しなければならない

3. WHEN テスト登録を実行したとき、THE スクリプトは、registerPatient circuitを呼び出さなければならない

4. WHEN 登録が完了したとき、THE スクリプトは、統計情報を取得して表示しなければならない

5. WHEN 検証が成功したとき、THE スクリプトは、成功メッセージを出力しなければならない

### 要件4: エラーハンドリング

**ユーザーストーリー:**

開発者として、デプロイ失敗時に明確なエラーメッセージを受け取りたい。
そうすることで、問題を迅速に特定し修正できる。

#### 受入基準

1. IF ウォレットシードが提供されていない場合、THEN THE スクリプトは、明確なエラーメッセージを表示して終了しなければならない

2. IF ネットワーク接続に失敗した場合、THEN THE スクリプトは、接続エラーを表示しなければならない

3. IF 資金が不足している場合、THEN THE スクリプトは、必要な資金量を表示しなければならない

4. IF デプロイに失敗した場合、THEN THE スクリプトは、エラー詳細をログに記録しなければならない

5. THE スクリプトは、すべてのリソース（ウォレット、プロバイダー）を適切にクリーンアップしなければならない

### 要件5: ドキュメント作成

**ユーザーストーリー:**

開発者として、デプロイ手順を記載したドキュメントが欲しい。
そうすることで、チームメンバーが簡単にデプロイを実行できる。

#### 受入基準

1. THE ドキュメントは、環境変数の設定方法を説明しなければならない

2. THE ドキュメントは、各環境へのデプロイ手順を記載しなければならない

3. THE ドキュメントは、トラブルシューティングガイドを含まなければならない

4. THE ドキュメントは、デプロイ後の検証手順を説明しなければならない

5. THE ドキュメントは、コードサンプルを含まなければならない

## 技術的制約

1. **既存インフラの活用**: pkgs/cliの既存コードを最大限活用
2. **環境変数**: .envファイルで設定を管理
3. **状態管理**: ウォレット状態をファイルにキャッシュ
4. **ログ**: pinoを使用した構造化ログ
5. **TypeScript**: 既存のTypeScript設定を使用

## セキュリティ要件

1. ウォレットシードは環境変数で管理（ハードコード禁止）
2. 状態キャッシュファイルは.gitignoreに追加
3. デプロイログに機密情報を含めない
4. 本番環境では必ず新しいシードを使用
5. テスト用シードと本番用シードを分離

## 非機能要件

1. **信頼性**: デプロイ失敗時の自動リトライ
2. **可観測性**: 詳細なログ出力
3. **再現性**: 同じシードで同じ結果を得られる
4. **保守性**: 既存のcounterデプロイスクリプトと一貫性
5. **ドキュメント**: 完全な手順書
